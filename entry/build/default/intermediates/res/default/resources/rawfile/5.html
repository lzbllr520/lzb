<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROS 导航接口监控</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #1e3a5f;
            text-shadow: 1px 1px 2px #ccc;
        }
        #status-panel {
            width: 90%;
            max-width: 900px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
        }
        .topic-container {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .topic-container:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .topic-header {
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .topic-header b {
            font-family: 'Courier New', Courier, monospace;
            color: #0056b3;
        }
        pre {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            white-space: pre-wrap;       /* CSS3 */
            word-wrap: break-word;     /* IE */
            max-height: 300px;
            overflow-y: auto;
            color: #495057;
        }
        .status-connected { color: #28a745; font-weight: bold; }
        .status-disconnected { color: #dc3545; font-weight: bold; }
        .status-connecting { color: #fd7e14; font-weight: bold; }
    </style>
</head>
<body>

<h1>ROS 导航接口监控</h1>

<div id="status-panel">
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 配置 ---
        // 修改为你的 rosbridge WebSocket 地址。
        // 下方是您指定的11个话题列表。
        const config = {
            websocketUrl: 'ws://192.168.2.19:9090', // <-- 修改我!
            topics: {
                // 定位与位置
                robotPose: { name: '/robot_pose', type: 'geometry_msgs/PoseStamped' },

                // 导航状态与控制
                moveBaseStatus: { name: '/move_base/status', type: 'actionlib_msgs/GoalStatusArray' },
                currentGoal: { name: '/move_base/current_goal', type: 'geometry_msgs/PoseStamped' },
                moveBaseResult: { name: '/move_base/result', type: 'move_base_msgs/MoveBaseActionResult' },

                // 路径规划
                globalPlan: { name: '/move_base/DWAPlannerROS/global_plan', type: 'nav_msgs/Path' },
                localPlan: { name: '/move_base/DWAPlannerROS/local_plan', type: 'nav_msgs/Path' },

                // 代价地图
                globalCostmap: { name: '/move_base/global_costmap/costmap', type: 'nav_msgs/OccupancyGrid' },
                localCostmap: { name: '/move_base/local_costmap/costmap', type: 'nav_msgs/OccupancyGrid' },

                // 机器人足迹
                globalFootprint: { name: '/move_base/global_costmap/footprint', type: 'geometry_msgs/PolygonStamped' },
                localFootprint: { name: '/move_base/local_costmap/footprint', type: 'geometry_msgs/PolygonStamped' },

                // 速度命令
                cmdVel: { name: '/cmd_vel', type: 'geometry_msgs/Twist' }
            }
        };

        // --- 状态变量 ---
        let rosSocket = null;
        let hasReceived = {}; // 用于跟踪每个话题是否已接收到第一条消息

        const statusPanel = document.getElementById('status-panel');

        // --- 动态生成UI ---
        function generateUI() {
            statusPanel.innerHTML = ''; // 清空现有内容

            // 创建主连接状态
            const connectionDiv = document.createElement('div');
            connectionDiv.className = 'topic-container';
            connectionDiv.innerHTML = `
                <div class="topic-header">
                    <b>服务器连接状态</b>
                    <span id="connection-status" class="status-disconnected">未连接</span>
                </div>`;
            statusPanel.appendChild(connectionDiv);

            // 为每个话题创建监控区域
            for (const key in config.topics) {
                const topic = config.topics[key];
                const topicDiv = document.createElement('div');
                topicDiv.className = 'topic-container';
                topicDiv.innerHTML = `
                    <div class="topic-header">
                        <b>${topic.name}</b>
                        <span id="status-${key}" class="status-disconnected">等待数据...</span>
                    </div>
                    <pre id="data-${key}">尚未接收到数据。</pre>
                `;
                statusPanel.appendChild(topicDiv);
            }
        }

        // --- WebSocket 连接 ---
        function connect() {
            rosSocket = new WebSocket(config.websocketUrl);
            const connectionStatusEl = document.getElementById('connection-status');

            rosSocket.onopen = () => {
                console.log('成功连接到 rosbridge server。');
                connectionStatusEl.textContent = '已连接';
                connectionStatusEl.className = 'status-connected';
                subscribeToTopics();
            };

            rosSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleTopicMessage(data);
            };

            rosSocket.onclose = () => {
                console.log('与 rosbridge server 的连接已断开。将在5秒后重试...');
                resetAllStatuses();
                setTimeout(connect, 5000);
            };

            rosSocket.onerror = (error) => {
                console.error('WebSocket 错误:', error);
                const connectionStatusEl = document.getElementById('connection-status');
                if (connectionStatusEl) {
                    connectionStatusEl.textContent = '连接错误';
                    connectionStatusEl.className = 'status-disconnected';
                }
                rosSocket.close();
            };

            if (connectionStatusEl) {
                connectionStatusEl.textContent = '正在连接...';
                connectionStatusEl.className = 'status-connecting';
            }
        }

        function subscribeToTopics() {
            Object.values(config.topics).forEach(topic => {
                const subscribeMsg = { op: 'subscribe', topic: topic.name, type: topic.type };
                rosSocket.send(JSON.stringify(subscribeMsg));
                console.log(`已发送订阅请求: ${topic.name}`);
            });
        }

        function handleTopicMessage(data) {
            const topicName = data.topic;
            if (!topicName) return;

            // 根据话题名称找到其在config中的key
            const topicKey = Object.keys(config.topics).find(key => config.topics[key].name === topicName);
            if (!topicKey || hasReceived[topicKey]) {
                return; // 如果话题不在配置中或已接收过，则忽略
            }

            hasReceived[topicKey] = true; // 标记为已接收

            console.log(`接收到来自 ${topicName} 的首条数据:`, data.msg);

            // 更新UI
            const statusEl = document.getElementById(`status-${topicKey}`);
            const dataEl = document.getElementById(`data-${topicKey}`);

            if (statusEl) {
                statusEl.textContent = '已接收 ✔';
                statusEl.className = 'status-connected';
            }
            if (dataEl) {
                // 将消息对象格式化为JSON字符串并显示
                dataEl.textContent = JSON.stringify(data.msg, null, 2);
            }
        }

        function resetAllStatuses() {
            const connectionStatusEl = document.getElementById('connection-status');
            if (connectionStatusEl) {
                connectionStatusEl.textContent = '已断开 (5秒后重试)';
                connectionStatusEl.className = 'status-disconnected';
            }

            // 重置所有话题的状态
            hasReceived = {};
            for (const key in config.topics) {
                const statusEl = document.getElementById(`status-${key}`);
                const dataEl = document.getElementById(`data-${key}`);
                 if (statusEl) {
                    statusEl.textContent = '等待数据...';
                    statusEl.className = 'status-disconnected';
                }
                if (dataEl) {
                    dataEl.textContent = '尚未接收到数据。';
                }
            }
        }

        // --- 启动程序 ---
        generateUI();
        connect();
    });
</script>

</body>
</html>