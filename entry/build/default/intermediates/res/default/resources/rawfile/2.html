<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ROS å®æ—¶ç»¼åˆè§†å›¾</title>
<style>
    /* æ‚¨çš„ç¾åŒ–æ ·å¼å¯ä»¥ä¿æŒä¸å˜ */
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background-color: #f0f2f5;
        color: #333;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    h1 {
        color: #1e3a5f;
    }
    .canvas-container {
        background-color: #ffffff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 15px;
    }
    #viewer-canvas { /* æ³¨æ„IDçš„ç»Ÿä¸€ */
        background-color: #777; /* ä½¿ç”¨RVizé£æ ¼çš„èƒŒæ™¯è‰² */
    }
    h2 {
        margin-top: 0;
    }
    #status-panel {
        width: 870px; /* åŒ¹é…Canvaså®½åº¦ */
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        border: 1px solid #ddd;
    }
    #status-panel p { margin: 5px 0; font-size: 14px; }
    #connection-status { font-weight: bold; }
    .status-connected { color: #28a745; }
    .status-disconnected { color: #dc3545; }
</style>

<script src="./eventemitter2.min.js"></script>
<script src="./easeljs.min.js"></script>
<script src="./roslib.min.js"></script>
<script src="./ros2d.js"></script> </head>
<body onload="init()">

    <h1>ROS å®æ—¶ç»¼åˆè§†å›¾</h1>

    <div id="status-panel">
        <p><b>è¿æ¥çŠ¶æ€:</b> <span id="connection-status" class="status-disconnected">æœªè¿æ¥</span></p>
        <p><b>é‡Œç¨‹è®¡ (/odom):</b> <span id="odom-data">ç­‰å¾…æ•°æ®...</span></p>
        <p><b>æ¿€å…‰é›·è¾¾ (/scan):</b> <span id="scan-data">ç­‰å¾…æ•°æ®...</span></p>
    </div>

    <div class="canvas-container">
        <h2>ç»¼åˆè§†å›¾ (åœ°å›¾, ä½ç½®, æ¿€å…‰é›·è¾¾)</h2>
        <div id="viewer-canvas"></div> </div>

<script>
    function init() {
        // --- 1. ROS è¿æ¥è®¾ç½® ---
        const ros = new ROSLIB.Ros({
            url: 'ws://192.168.2.19:9090'
        });

        // --- DOM å…ƒç´ è·å– ---
        const connectionStatusEl = document.getElementById('connection-status');
        const odomDataEl = document.getElementById('odom-data');
        const scanDataEl = document.getElementById('scan-data');
        
        ros.on('connection', () => {
            console.log('âœ… å·²è¿æ¥åˆ° WebSocket æœåŠ¡å™¨ã€‚');
            connectionStatusEl.textContent = 'å·²è¿æ¥';
            connectionStatusEl.className = 'status-connected';
        });
        ros.on('error', (error) => {
            console.error('âŒ è¿æ¥ WebSocket æœåŠ¡å™¨å‡ºé”™: ', error);
        });
        ros.on('close', () => {
            console.log('ğŸ”Œ å·²æ–­å¼€ä¸ WebSocket æœåŠ¡å™¨çš„è¿æ¥ã€‚');
            connectionStatusEl.textContent = 'å·²æ–­å¼€';
            connectionStatusEl.className = 'status-disconnected';
        });

        // --- 2. åˆ›å»º Viewer ---
        const viewer = new ROS2D.Viewer({
            divID: 'viewer-canvas',
            width: 870,
            height: 800
        });

        // --- 3. è®¾ç½®åœ°å›¾å®¢æˆ·ç«¯ ---
        const gridClient = new ROS2D.OccupancyGridClient({
            ros: ros,
            rootObject: viewer.scene,
            continuous: true 
        });

        gridClient.on('change', () => {
            viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
            viewer.shift(gridClient.currentGrid.pose.position.x, gridClient.currentGrid.pose.position.y);
        });

        // =======================================================
        // ========== 4. æ•´åˆæ‚¨çš„æœºå™¨äººå’Œå°è½¦ç»˜åˆ¶é€»è¾‘ ==========
        // =======================================================

        // åˆ›å»ºä¸€ä¸ª createjs.Shape å¯¹è±¡æ¥ç»˜åˆ¶æœºå™¨äºº
        const robotMarker = new createjs.Shape();
        viewer.scene.addChild(robotMarker);

        // åˆ›å»ºä¸€ä¸ª createjs.Shape å¯¹è±¡æ¥ç»˜åˆ¶æ¿€å…‰ç‚¹
        const laserScanMarker = new createjs.Shape();
        viewer.scene.addChild(laserScanMarker);

        // è®¢é˜… /odom è¯é¢˜
        const odomListener = new ROSLIB.Topic({
            ros: ros,
            name: '/odom',
            messageType: 'nav_msgs/Odometry'
        });

        odomListener.subscribe((message) => {
            const pose = message.pose.pose;
            const x = pose.position.x;
            const y = -pose.position.y; // Yè½´åè½¬
            
            // è®¡ç®—æœå‘
            const q = pose.orientation;
            const yaw = -Math.atan2(2 * (q.w * q.z + q.x * q.y), 1 - 2 * (q.y * q.y + q.z * q.z));
            const rotation = yaw * 180 / Math.PI; // è½¬æ¢ä¸ºè§’åº¦

            // æ›´æ–°æœºå™¨äººä½ç½®å’Œæœå‘
            robotMarker.x = x;
            robotMarker.y = y;
            robotMarker.rotation = rotation;
            
            // ä½¿ç”¨EaselJSçš„Graphics APIé‡ç»˜æœºå™¨äººå½¢çŠ¶ (è“è‰²åœ†åœˆ+ç™½è‰²ç®­å¤´)
            robotMarker.graphics.clear()
                .beginFill('rgba(0, 80, 200, 0.9)').drawCircle(0, 0, 0.125) // ç»˜åˆ¶æœºå™¨äººä¸»ä½“
                .beginStroke('white').setStrokeStyle(0.05)
                .moveTo(0, 0).lineTo(0.25, 0).endStroke(); // ç»˜åˆ¶æœå‘ç®­å¤´
            
            // æ›´æ–°çŠ¶æ€é¢æ¿
            odomDataEl.textContent = `X: ${x.toFixed(2)}m, Y: ${(-y).toFixed(2)}m, Î¸: ${(rotation).toFixed(1)}Â°`;
        });
        
        // è®¢é˜… /scan è¯é¢˜
        const scanListener = new ROSLIB.Topic({
            ros: ros,
            name: '/scan',
            messageType: 'sensor_msgs/LaserScan'
        });

        scanListener.subscribe((message) => {
            // é¦–å…ˆï¼Œæ¸…é™¤æ—§çš„æ¿€å…‰ç‚¹
            laserScanMarker.graphics.clear();
            
            // å¼€å§‹ç»˜åˆ¶æ–°çš„ç‚¹
            laserScanMarker.graphics.beginFill('rgba(255, 20, 20, 0.7)');

            const { ranges, angle_min, angle_increment } = message;
            
            for (let i = 0; i < ranges.length; i++) {
                const range = ranges[i];
                if (range > message.range_min && range < message.range_max) {
                    const angle = angle_min + i * angle_increment;
                    const pointX = range * Math.cos(angle);
                    const pointY = -range * Math.sin(angle); // Yè½´åè½¬
                    laserScanMarker.graphics.drawCircle(pointX, pointY, 0.05);
                }
            }
            laserScanMarker.graphics.endFill();

            // å°†æ¿€å…‰ç‚¹çš„ä½ç½®å’Œæœå‘ä¸æœºå™¨äººåŒæ­¥
            laserScanMarker.x = robotMarker.x;
            laserScanMarker.y = robotMarker.y;
            laserScanMarker.rotation = robotMarker.rotation;

            // æ›´æ–°çŠ¶æ€é¢æ¿
            scanDataEl.textContent = `æ¥æ”¶åˆ° ${ranges.length} ä¸ªç‚¹`;
        });
    }
</script>

</body>
</html>