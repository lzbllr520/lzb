<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ROS 实时综合视图</title>

    <script src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ros2d/build/ros2d.min.js"></script>

    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; margin: 20px; background-color: #f0f2f5; }
        #status { margin-bottom: 20px; font-size: 1.2em; color: #333; }
        #viewer-container { border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body onload="init()">
    <h1>ROS 实时综合视图 (由 ros2djs 驱动)</h1>
    <div id="status">正在初始化...</div>
    <div id="viewer-container"></div>

    <script>
      function init() {
        // --- 配置 ---
        const WEBSOCKET_URL = 'ws://192.168.2.19:9090'; // <-- 已为您填好IP
        const FIXED_FRAME = '/map';
        const VIEWER_WIDTH = 900;
        const VIEWER_HEIGHT = 900;

        const statusDiv = document.getElementById('status');

        // --- ROS 连接 ---
        const ros = new ROSLIB.Ros({ url: WEBSOCKET_URL });

        ros.on('connection', () => {
            console.log('✅ 成功连接到 rosbridge server。');
            statusDiv.innerHTML = '✅ 已连接到 rosbridge server';
            loadVisualizations(ros);
        });

        ros.on('error', (error) => {
            console.error('ROS 连接错误:', error);
            statusDiv.innerHTML = '❌ 连接错误，请检查 rosbridge URL 和服务状态。';
        });

        ros.on('close', () => {
            console.log('与 rosbridge 的连接已断开。');
            statusDiv.innerHTML = '🔌 连接已断开。';
        });

        function loadVisualizations(ros) {
            // 1. 创建一个 2D 视图
            const viewer = new ROS2D.Viewer({
                divID: 'viewer-container',
                width: VIEWER_WIDTH,
                height: VIEWER_HEIGHT
            });

            // 2. 创建一个 TF 客户端，这是实现自动坐标对齐的核心！
            const tfClient = new ROSLIB.TFClient({
                ros: ros,
                angularThres: 0.01,
                transThres: 0.01,
                rate: 10.0,
                fixedFrame: FIXED_FRAME
            });

            // 3. 创建地图客户端
            new ROS2D.OccupancyGridClient({
                ros: ros,
                topic: '/map',
                rootObject: viewer.scene,
                continuous: true
            });

            // 4. 创建激光雷达可视化
            new ROS2D.LaserScan({
                ros: ros,
                topic: '/scan',
                tfClient: tfClient, // 传入TF客户端，自动处理坐标变换
                rootObject: viewer.scene,
                size: 5,
                fillColor: createjs.Graphics.getRGB(255, 0, 0, 0.8)
            });
            
            // 5. 创建机器人模型可视化 (箭头)
            const robotMarker = new ROS2D.ArrowShape({
                size: 12,
                strokeSize: 1,
                fillColor: createjs.Graphics.getRGB(0, 80, 200, 0.8)
            });
            viewer.scene.addChild(robotMarker);
            
            // 使用 TF 客户端来自动更新机器人的位置
            const robotFrame = '/base_link'; 
            tfClient.subscribe(robotFrame, (tf) => {
                robotMarker.x = tf.translation.x;
                robotMarker.y = -tf.translation.y; // ros2djs的Y轴与ROS相反
                
                const q = tf.rotation;
                const yaw = Math.atan2(2 * (q.w * q.z + q.x * q.y), 1 - 2 * (q.y * q.y + q.z * q.z));
                robotMarker.rotation = -yaw * 180 / Math.PI; // ros2djs的角度单位是度，且方向相反
            });
        }
      }
    </script>
</body>
</html>