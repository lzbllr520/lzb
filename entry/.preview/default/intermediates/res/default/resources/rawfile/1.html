<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ROS å®æ—¶ç»¼åˆè§†å›¾</title>

    <script src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ros2d/build/ros2d.min.js"></script>

    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; margin: 20px; background-color: #f0f2f5; }
        #status { margin-bottom: 20px; font-size: 1.2em; color: #333; }
        #viewer-container { border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body onload="init()">
    <h1>ROS å®æ—¶ç»¼åˆè§†å›¾ (ç”± ros2djs é©±åŠ¨)</h1>
    <div id="status">æ­£åœ¨åˆå§‹åŒ–...</div>
    <div id="viewer-container"></div>

    <script>
      function init() {
        // --- é…ç½® ---
        const WEBSOCKET_URL = 'ws://192.168.2.19:9090'; // <-- å·²ä¸ºæ‚¨å¡«å¥½IP
        const FIXED_FRAME = '/map';
        const VIEWER_WIDTH = 900;
        const VIEWER_HEIGHT = 900;

        const statusDiv = document.getElementById('status');

        // --- ROS è¿æ¥ ---
        const ros = new ROSLIB.Ros({ url: WEBSOCKET_URL });

        ros.on('connection', () => {
            console.log('âœ… æˆåŠŸè¿æ¥åˆ° rosbridge serverã€‚');
            statusDiv.innerHTML = 'âœ… å·²è¿æ¥åˆ° rosbridge server';
            loadVisualizations(ros);
        });

        ros.on('error', (error) => {
            console.error('ROS è¿æ¥é”™è¯¯:', error);
            statusDiv.innerHTML = 'âŒ è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ rosbridge URL å’ŒæœåŠ¡çŠ¶æ€ã€‚';
        });

        ros.on('close', () => {
            console.log('ä¸ rosbridge çš„è¿æ¥å·²æ–­å¼€ã€‚');
            statusDiv.innerHTML = 'ğŸ”Œ è¿æ¥å·²æ–­å¼€ã€‚';
        });

        function loadVisualizations(ros) {
            // 1. åˆ›å»ºä¸€ä¸ª 2D è§†å›¾
            const viewer = new ROS2D.Viewer({
                divID: 'viewer-container',
                width: VIEWER_WIDTH,
                height: VIEWER_HEIGHT
            });

            // 2. åˆ›å»ºä¸€ä¸ª TF å®¢æˆ·ç«¯ï¼Œè¿™æ˜¯å®ç°è‡ªåŠ¨åæ ‡å¯¹é½çš„æ ¸å¿ƒï¼
            const tfClient = new ROSLIB.TFClient({
                ros: ros,
                angularThres: 0.01,
                transThres: 0.01,
                rate: 10.0,
                fixedFrame: FIXED_FRAME
            });

            // 3. åˆ›å»ºåœ°å›¾å®¢æˆ·ç«¯
            new ROS2D.OccupancyGridClient({
                ros: ros,
                topic: '/map',
                rootObject: viewer.scene,
                continuous: true
            });

            // 4. åˆ›å»ºæ¿€å…‰é›·è¾¾å¯è§†åŒ–
            new ROS2D.LaserScan({
                ros: ros,
                topic: '/scan',
                tfClient: tfClient, // ä¼ å…¥TFå®¢æˆ·ç«¯ï¼Œè‡ªåŠ¨å¤„ç†åæ ‡å˜æ¢
                rootObject: viewer.scene,
                size: 5,
                fillColor: createjs.Graphics.getRGB(255, 0, 0, 0.8)
            });
            
            // 5. åˆ›å»ºæœºå™¨äººæ¨¡å‹å¯è§†åŒ– (ç®­å¤´)
            const robotMarker = new ROS2D.ArrowShape({
                size: 12,
                strokeSize: 1,
                fillColor: createjs.Graphics.getRGB(0, 80, 200, 0.8)
            });
            viewer.scene.addChild(robotMarker);
            
            // ä½¿ç”¨ TF å®¢æˆ·ç«¯æ¥è‡ªåŠ¨æ›´æ–°æœºå™¨äººçš„ä½ç½®
            const robotFrame = '/base_link'; 
            tfClient.subscribe(robotFrame, (tf) => {
                robotMarker.x = tf.translation.x;
                robotMarker.y = -tf.translation.y; // ros2djsçš„Yè½´ä¸ROSç›¸å
                
                const q = tf.rotation;
                const yaw = Math.atan2(2 * (q.w * q.z + q.x * q.y), 1 - 2 * (q.y * q.y + q.z * q.z));
                robotMarker.rotation = -yaw * 180 / Math.PI; // ros2djsçš„è§’åº¦å•ä½æ˜¯åº¦ï¼Œä¸”æ–¹å‘ç›¸å
            });
        }
      }
    </script>
</body>
</html>